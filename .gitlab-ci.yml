stages:
  - base
  - dind

variables:
  DOCKER_VERSION: 19.03.1
  DOCKER_BUILDKIT: 1
services:
  - registry.gitlab.com/jitesoft/dockerfiles/docker/dind:18.09.8
image: registry.gitlab.com/jitesoft/dockerfiles/docker:18.09.8

build:docker:
  stage: base
  before_script:
    - echo ${CI_JOB_TOKEN} | docker login -u gitlab-ci-token registry.gitlab.com --password-stdin
  script:
    - docker --version
    - dockerd --version
    - docker build -t ${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHA} --build-arg DOCKER_VERSION=${DOCKER_VERSION} .
    - docker tag ${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHA} ${CI_REGISTRY_IMAGE}:${DOCKER_VERSION}
    - docker tag ${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHA} ${CI_REGISTRY_IMAGE}:latest
    - docker push ${CI_REGISTRY_IMAGE}:${DOCKER_VERSION}
    - docker push ${CI_REGISTRY_IMAGE}:latest
  tags:
    - jitesoft
  only:
    refs:
      - master

build:dind:
  stage: dind
  before_script:
    - echo ${CI_JOB_TOKEN} | docker login -u gitlab-ci-token registry.gitlab.com --password-stdin
  script:
    - cd Dind
    - docker build -t ${CI_REGISTRY_IMAGE}/dind:${CI_COMMIT_SHA} --build-arg DOCKER_VERSION=${DOCKER_VERSION} .
    - docker tag ${CI_REGISTRY_IMAGE}/dind:${CI_COMMIT_SHA} ${CI_REGISTRY_IMAGE}/dind:${DOCKER_VERSION}
    - docker tag ${CI_REGISTRY_IMAGE}/dind:${CI_COMMIT_SHA} ${CI_REGISTRY_IMAGE}/dind:latest
    - docker push ${CI_REGISTRY_IMAGE}/dind:${DOCKER_VERSION}
    - docker push ${CI_REGISTRY_IMAGE}/dind:latest
  tags:
    - jitesoft
  only:
    refs:
      - master
